@model IEnumerable<LibraryManagement.Models.contact_messages>
@{
    ViewBag.Title = "Admin Messages";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}

<div class="container">
    <h2>User Queries</h2>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Email</th>
                <th>Subject</th>
                <th>Message</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var message in Model)
            {
                <tr>
                    <td>@message.email</td>
                    <td>@message.subject</td>
                    <td>@message.message</td>
                    <td>@message.created_at</td>
                    <td>
                        <!-- Button to open the modal and populate the email -->
                        <button type="button" class="btn btn-primary reply-btn" data-toggle="modal" data-target="#replyModal" data-email="@message.email">
                            Reply
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1" role="dialog" aria-labelledby="replyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="replyModalLabel">Reply to Message</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="replyForm" action="@Url.Action("SendReply", "Admin")" method="post">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="text" class="form-control" id="email" name="email" readonly />
                    </div>
                    <div class="form-group">
                        <label for="message">Message</label>
                        <textarea class="form-control" id="message" name="message" rows="5"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" form="replyForm">Send Reply</button>
            </div>
        </div>
    </div>
</div>




<!-- Script to handle email passing and form validation -->
<script>
    $(document).ready(function () {
        // When the modal is triggered, populate the email field
        $('#replyModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);  // Button that triggered the modal
            var email = button.data('email');     // Extract the email from data-* attribute
            console.log("Email received: " + email);  // Log the email to console to check if it's correct
            var modal = $(this);
            modal.find('.modal-body #email').val(email);  // Insert the email into the modal
        });

        // Handle form submission using AJAX
        $('#replyForm').on('submit', function (e) {
            e.preventDefault();  // Prevent the default form submission

            var form = $(this);
            var formData = form.serialize();  // Serialize the form data
            console.log("Form is being submitted");  // Log when the form is being submitted

            // AJAX request
            $.ajax({
                type: 'POST',
                url: form.attr('action'),
                data: formData,
                success: function (response) {
                    console.log("Response: ", response);  // Log the server response
                    alert('Reply sent successfully!');
                    $('#replyModal').modal('hide');  // Hide the modal on success
                    location.reload();  // Reload the page to see the success message
                },
                error: function (error) {
                    console.log("Error: ", error);  // Log error in the console
                    alert('Error: Could not send the reply.');
                }
            });
        });
    });
</script>


<!-- Bootstrap and jQuery dependencies -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
